import { createMagentoClient } from '../clients/magentoClient'
import type {
  CommerceProvider,
  CommerceProduct,
  CommerceListParams,
  CommerceListResult,
  CommerceCategory,
  CommerceCart,
  CommerceCustomer,
  CommerceOrder,
  ProviderContext,
  Address,
} from '../types'

import {
  ProductsDocument,
  type ProductsQuery,
  type ProductsQueryVariables,
} from '../generated/magento/graphql'

import { normalizeMagentoProduct } from '../normalization/magento/product'
import { normalizeMagentoCategory } from '../normalization/magento/category'
import { normalizeMagentoCart } from '../normalization/magento/cart'

type MagentoProduct = NonNullable<NonNullable<ProductsQuery['products']>['items']>[number]

/**
 * Helper function to build Magento filters from generic filter object
 */
function buildMagentoFilters(filters: Record<string, string | string[] | number[]>): Record<string, unknown> {
  const magentoFilters: Record<string, unknown> = {}
  
  for (const [key, value] of Object.entries(filters)) {
    if (Array.isArray(value)) {
      magentoFilters[key] = { in: value }
    }
    else {
      magentoFilters[key] = { eq: value }
    }
  }
  
  return magentoFilters
}

/**
 * Magento Commerce Provider Implementation
 * Handles all commerce operations for Magento 2 / Adobe Commerce
 */
export const createMagentoProvider = (ctx: ProviderContext): CommerceProvider => {
  const endpoint = ctx.endpoint
  if (!endpoint) {
    throw new Error('[Magento Provider] Endpoint is required')
  }

  const token = ctx.token
  const storeCode = ctx.storeCode || 'default'
  const logger = ctx.logger

  logger?.info('[Magento Provider] Initializing', { endpoint, storeCode })

  const client = createMagentoClient({
    endpoint,
    token,
    storeCode,
  })

  return {
    // =========================================================================
    // Product Operations
    // =========================================================================
    
    async getProduct(id: string): Promise<CommerceProduct | null> {
      try {
        const variables: ProductsQueryVariables = {
          filter: null,
          search: id,
          filter1: null,
          pageSize: 1,
          currentPage: 1,
          sort: null,
        }

        const data = await client.request<ProductsQuery>(
          ProductsDocument,
          variables,
        )

        const item = data.products?.items?.[0]
        if (!item) {
          logger?.warn('[Magento Provider] Product not found', { id })
          return null
        }

        return normalizeMagentoProduct(item as MagentoProduct)
      }
      catch (error) {
        logger?.error('[Magento Provider] Failed to fetch product', { id, error })
        throw error
      }
    },

    async getProducts(params?: CommerceListParams): Promise<CommerceListResult<CommerceProduct>> {
      try {
        const variables: ProductsQueryVariables = {
          filter: null,
          search: params?.search || null,
          filter1: params?.filters ? buildMagentoFilters(params.filters) as any : null,
          pageSize: params?.pageSize || 20,
          currentPage: params?.page || 1,
          sort: null, // Magento sort needs specific implementation based on ProductAttributeSortInput
        }

        const data = await client.request<ProductsQuery>(
          ProductsDocument,
          variables,
        )

        const items = (data.products?.items || []).map(item =>
          normalizeMagentoProduct(item as MagentoProduct),
        )

        const total = data.products?.total_count || 0
        const pageSize = params?.pageSize || 20
        const page = params?.page || 1

        return {
          items,
          total,
          page,
          pageSize,
          totalPages: Math.ceil(total / pageSize),
        }
      }
      catch (error) {
        logger?.error('[Magento Provider] Failed to fetch products', { params, error })
        throw error
      }
    },

    async getProductBySku(sku: string): Promise<CommerceProduct | null> {
      try {
        const variables: ProductsQueryVariables = {
          filter: { sku: { eq: sku } },
          search: null,
          filter1: null,
          pageSize: 1,
          currentPage: 1,
          sort: null,
        }

        const data = await client.request<ProductsQuery>(
          ProductsDocument,
          variables,
        )

        const item = data.products?.items?.[0]
        if (!item) {
          logger?.warn('[Magento Provider] Product not found by SKU', { sku })
          return null
        }

        return normalizeMagentoProduct(item as MagentoProduct)
      }
      catch (error) {
        logger?.error('[Magento Provider] Failed to fetch product by SKU', { sku, error })
        throw error
      }
    },

    async searchProducts(
      query: string,
      params?: CommerceListParams,
    ): Promise<CommerceListResult<CommerceProduct>> {
      return this.getProducts({
        ...params,
        search: query,
      })
    },

    // =========================================================================
    // Category Operations
    // =========================================================================

    async getCategory(id: string): Promise<CommerceCategory | null> {
      try {
        // TODO: Implement with Magento category query
        logger?.warn('[Magento Provider] getCategory not yet implemented', { id })
        return null
      }
      catch (error) {
        logger?.error('[Magento Provider] Failed to fetch category', { id, error })
        throw error
      }
    },

    async getCategories(parentId?: string): Promise<CommerceCategory[]> {
      try {
        // TODO: Implement with Magento categories query
        logger?.warn('[Magento Provider] getCategories not yet implemented', { parentId })
        return []
      }
      catch (error) {
        logger?.error('[Magento Provider] Failed to fetch categories', { parentId, error })
        throw error
      }
    },

    async getCategoryTree(): Promise<CommerceCategory[]> {
      try {
        // TODO: Implement with Magento category tree query
        logger?.warn('[Magento Provider] getCategoryTree not yet implemented')
        return []
      }
      catch (error) {
        logger?.error('[Magento Provider] Failed to fetch category tree', { error })
        throw error
      }
    },

    // =========================================================================
    // Cart Operations
    // =========================================================================

    async createCart(): Promise<CommerceCart> {
      try {
        // TODO: Implement with Magento createEmptyCart mutation
        logger?.warn('[Magento Provider] createCart not yet implemented')
        throw new Error('Not implemented')
      }
      catch (error) {
        logger?.error('[Magento Provider] Failed to create cart', { error })
        throw error
      }
    },

    async getCart(cartId: string): Promise<CommerceCart | null> {
      try {
        // TODO: Implement with Magento cart query
        logger?.warn('[Magento Provider] getCart not yet implemented', { cartId })
        return null
      }
      catch (error) {
        logger?.error('[Magento Provider] Failed to fetch cart', { cartId, error })
        throw error
      }
    },

    async addToCart(
      cartId: string,
      productId: string,
      quantity: number,
      variantId?: string,
    ): Promise<CommerceCart> {
      try {
        // TODO: Implement with Magento addProductsToCart mutation
        logger?.warn('[Magento Provider] addToCart not yet implemented', {
          cartId,
          productId,
          quantity,
          variantId,
        })
        throw new Error('Not implemented')
      }
      catch (error) {
        logger?.error('[Magento Provider] Failed to add to cart', {
          cartId,
          productId,
          quantity,
          error,
        })
        throw error
      }
    },

    async updateCartItem(
      cartId: string,
      itemId: string,
      quantity: number,
    ): Promise<CommerceCart> {
      try {
        // TODO: Implement with Magento updateCartItems mutation
        logger?.warn('[Magento Provider] updateCartItem not yet implemented', {
          cartId,
          itemId,
          quantity,
        })
        throw new Error('Not implemented')
      }
      catch (error) {
        logger?.error('[Magento Provider] Failed to update cart item', {
          cartId,
          itemId,
          quantity,
          error,
        })
        throw error
      }
    },

    async removeFromCart(cartId: string, itemId: string): Promise<CommerceCart> {
      try {
        // TODO: Implement with Magento removeItemFromCart mutation
        logger?.warn('[Magento Provider] removeFromCart not yet implemented', {
          cartId,
          itemId,
        })
        throw new Error('Not implemented')
      }
      catch (error) {
        logger?.error('[Magento Provider] Failed to remove from cart', {
          cartId,
          itemId,
          error,
        })
        throw error
      }
    },

    async applyCoupon(cartId: string, couponCode: string): Promise<CommerceCart> {
      try {
        // TODO: Implement with Magento applyCouponToCart mutation
        logger?.warn('[Magento Provider] applyCoupon not yet implemented', {
          cartId,
          couponCode,
        })
        throw new Error('Not implemented')
      }
      catch (error) {
        logger?.error('[Magento Provider] Failed to apply coupon', {
          cartId,
          couponCode,
          error,
        })
        throw error
      }
    },

    async removeCoupon(cartId: string): Promise<CommerceCart> {
      try {
        // TODO: Implement with Magento removeCouponFromCart mutation
        logger?.warn('[Magento Provider] removeCoupon not yet implemented', { cartId })
        throw new Error('Not implemented')
      }
      catch (error) {
        logger?.error('[Magento Provider] Failed to remove coupon', { cartId, error })
        throw error
      }
    },

    // =========================================================================
    // Customer Operations
    // =========================================================================

    async getCustomer(customerId: string): Promise<CommerceCustomer | null> {
      try {
        // TODO: Implement with Magento customer query
        logger?.warn('[Magento Provider] getCustomer not yet implemented', { customerId })
        return null
      }
      catch (error) {
        logger?.error('[Magento Provider] Failed to fetch customer', { customerId, error })
        throw error
      }
    },

    async createCustomer(data: Partial<CommerceCustomer>): Promise<CommerceCustomer> {
      try {
        // TODO: Implement with Magento createCustomer mutation
        logger?.warn('[Magento Provider] createCustomer not yet implemented', { data })
        throw new Error('Not implemented')
      }
      catch (error) {
        logger?.error('[Magento Provider] Failed to create customer', { data, error })
        throw error
      }
    },

    async updateCustomer(
      customerId: string,
      data: Partial<CommerceCustomer>,
    ): Promise<CommerceCustomer> {
      try {
        // TODO: Implement with Magento updateCustomer mutation
        logger?.warn('[Magento Provider] updateCustomer not yet implemented', {
          customerId,
          data,
        })
        throw new Error('Not implemented')
      }
      catch (error) {
        logger?.error('[Magento Provider] Failed to update customer', {
          customerId,
          data,
          error,
        })
        throw error
      }
    },

    // =========================================================================
    // Order Operations
    // =========================================================================

    async getOrder(orderId: string): Promise<CommerceOrder | null> {
      try {
        // TODO: Implement with Magento order query
        logger?.warn('[Magento Provider] getOrder not yet implemented', { orderId })
        return null
      }
      catch (error) {
        logger?.error('[Magento Provider] Failed to fetch order', { orderId, error })
        throw error
      }
    },

    async getCustomerOrders(
      customerId: string,
      params?: CommerceListParams,
    ): Promise<CommerceListResult<CommerceOrder>> {
      try {
        // TODO: Implement with Magento customer orders query
        logger?.warn('[Magento Provider] getCustomerOrders not yet implemented', {
          customerId,
          params,
        })
        return {
          items: [],
          total: 0,
          page: 1,
          pageSize: 20,
          totalPages: 0,
        }
      }
      catch (error) {
        logger?.error('[Magento Provider] Failed to fetch customer orders', {
          customerId,
          params,
          error,
        })
        throw error
      }
    },

    async createOrder(
      cartId: string,
      shippingAddress: Address,
      billingAddress: Address,
      paymentMethod: string,
    ): Promise<CommerceOrder> {
      try {
        // TODO: Implement with Magento placeOrder mutation
        logger?.warn('[Magento Provider] createOrder not yet implemented', {
          cartId,
          shippingAddress,
          billingAddress,
          paymentMethod,
        })
        throw new Error('Not implemented')
      }
      catch (error) {
        logger?.error('[Magento Provider] Failed to create order', {
          cartId,
          shippingAddress,
          billingAddress,
          paymentMethod,
          error,
        })
        throw error
      }
    },
  }

  // Helper method for building filters
  function buildFilters(filters: Record<string, string | string[] | number[]>): Record<string, unknown> {
    const magentoFilters: Record<string, unknown> = {}
    
    for (const [key, value] of Object.entries(filters)) {
      if (Array.isArray(value)) {
        magentoFilters[key] = { in: value }
      }
      else {
        magentoFilters[key] = { eq: value }
      }
    }
    
    return magentoFilters
  }
}
