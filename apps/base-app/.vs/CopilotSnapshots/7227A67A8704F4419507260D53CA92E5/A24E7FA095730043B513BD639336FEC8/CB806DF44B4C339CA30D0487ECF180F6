import { ref, type Ref } from 'vue'
import { useNuxtApp } from 'nuxt/app'
import type { CommerceProduct } from '../types'

export interface UseCommerceProductReturn {
  product: Ref<CommerceProduct | null>
  loading: Ref<boolean>
  error: Ref<Error | null>
  load: () => Promise<void>
  refresh: () => Promise<void>
}

/**
 * Composable for fetching a single product
 * @param id Product ID (can be reactive)
 */
export function useCommerceProduct(id: string | Ref<string>): UseCommerceProductReturn {
  const { $commerce } = useNuxtApp()
  
  const product = ref<CommerceProduct | null>(null)
  const loading = ref(false)
  const error = ref<Error | null>(null)

  const load = async () => {
    const productId = typeof id === 'string' ? id : id.value
    
    if (!productId) {
      error.value = new Error('Product ID is required')
      return
    }

    loading.value = true
    error.value = null

    try {
      product.value = await $commerce.getProduct(productId)
    }
    catch (err) {
      error.value = err instanceof Error ? err : new Error(String(err))
      console.error('[useCommerceProduct] Failed to load product:', err)
    }
    finally {
      loading.value = false
    }
  }

  const refresh = load

  return {
    product,
    loading,
    error,
    load,
    refresh,
  }
}

/**
 * Composable for fetching a product by SKU
 * @param sku Product SKU (can be reactive)
 */
export function useCommerceProductBySku(sku: string | Ref<string>): UseCommerceProductReturn {
  const { $commerce } = useNuxtApp()
  
  const product = ref<CommerceProduct | null>(null)
  const loading = ref(false)
  const error = ref<Error | null>(null)

  const load = async () => {
    const productSku = typeof sku === 'string' ? sku : sku.value
    
    if (!productSku) {
      error.value = new Error('Product SKU is required')
      return
    }

    loading.value = true
    error.value = null

    try {
      product.value = await $commerce.getProductBySku(productSku)
    }
    catch (err) {
      error.value = err instanceof Error ? err : new Error(String(err))
      console.error('[useCommerceProductBySku] Failed to load product:', err)
    }
    finally {
      loading.value = false
    }
  }

  const refresh = load

  return {
    product,
    loading,
    error,
    load,
    refresh,
  }
}
