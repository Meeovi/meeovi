import { defineNuxtModule, addPlugin, createResolver, addImportsDir } from '@nuxt/kit'

// Module options TypeScript interface definition
export interface CommerceModuleOptions {
  provider: 'magento' | 'medusa' | 'shopify'
  endpoint: string
  token?: string
}

export default defineNuxtModule<CommerceModuleOptions>({
  meta: {
    name: 'nuxt-commerce',
    configKey: 'commerce',
  },

  defaults: {
    provider: 'magento',
    endpoint: '',
    token: '',
  },

  setup(options, nuxt) {
    const resolver = createResolver(process.cwd())

    nuxt.options.runtimeConfig.public.commerce = {
      ...(nuxt.options.runtimeConfig.public.commerce || {}),
      provider: options.provider,
      magentoEndpoint: process.env.MAGENTO_ENDPOINT,
    }

    nuxt.options.runtimeConfig.commerce = {
      ...(nuxt.options.runtimeConfig.commerce || {}),
      magentoToken: process.env.MAGENTO_TOKEN,
    }

    addPlugin(resolver.resolve('./runtime/plugin.commerce'))

    addImportsDir(resolver.resolve('./runtime/composables'))

    // Auto-import generated GraphQL documents
    addImportsDir(resolver.resolve('./runtime/generated'))

    // Register plugin
    addPlugin(resolver.resolve('./runtime/apollo/plugin'))

    // Ensure runtime code is transpiled
    nuxt.options.build.transpile.push(resolver.resolve('./src'))
    nuxt.options.build.transpile.push(resolver.resolve('./runtime'))
  },
})
